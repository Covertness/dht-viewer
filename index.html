<!DOCTYPE html>
<html>
    <head>
        <title>DHT viewer</title>
        <meta name="description" content="The real-time viewer for the DHT network.">
        <meta name="viewport" content="width=1024, maximum-scale=1">
        <style>
        	body {
        		margin: 0;
        		font-family: Helvetica, Arial, sans-serif;
        	}
        	.wrapper{
        		position: relative;
        		margin: 0 auto;
        		width: 1000px;
        		height: 1000px;
        		margin-bottom: 100px;
        	}
        	#heatmapContainer{
        		width: 100%;
        		height: 100%;
        		background: rgba(0,0,0,.03);
        		border: 2px solid #000;
        	}
        	.tooltip {
	        	position: absolute;
	        	left: 0;
	        	top: 0;
	        	background: rgba(0,0,0,.8);
	        	color: #fff;
	        	font-size: 14px;
	        	padding: 5px;
	        	line-height: 18px;
	        	display: none;
	        }
	        #footer {
	        	font-size: 10pt;
	        	background: #202020;
	        	padding: 20px 0 100px 50px;
	        	position: relative;
	        }
	        #footer a.github {
	        	    background: url(github.gif) no-repeat;
	        	    width: 68px;
	        	    height: 30px;
	        	    text-indent: -999em;
	        	    position: absolute;
	        	    bottom: 30px;
	        	    right: 30px;
	        }
        </style>
        <script src="lib/requirejs/require.js"></script>
    </head>
    <body>
        <h1 style="text-align:center">DHT viewer</h1>
        <a href="https://github.com/you"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/38ef81f8aca64bb9a64448d0d70f1308ef5341ab/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f6461726b626c75655f3132313632312e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png"></a>
        <div class="wrapper">
        	<div id="heatmapContainer"></div>
        	<div class="tooltip"></div>
        	<p>The real-time data is collected by the project: <a href="https://github.com/Covertness/node-dht-broker">node-dht-broker</a>. Getting the magnet link just by one click.</p>
        </div>
        <div id="desc"></div>
        <div id="footer">
        	<a class="github" href="http://github.com">Hosted on GitHub</a>
        </div>
        <script>
        	var dhtBroker = "dht.psychokinesis.me:8080";
        	var baseHot = 10;
        	require.config({
    			baseUrl: "lib",
    			paths: {
        			"heatmap": "heatmap.js-amd/build/heatmap",
        			"collections": "collections.min",
        			"spin": "spin.js/spin.min",
        			"clipboard": "clipboard/dist/clipboard.min"
    			},
    			waitSeconds: 15
  			});
  			require(["heatmap", "collections", "dojo/request", "spin", "clipboard"], function(heatmap, collections, request, Spinner, Clipboard) {
  				var heatmapContainer = document.getElementById('heatmapContainer');
        		var h = heatmap.create({
					container: heatmapContainer,
					radius: 20
				});
				var data = new Map({});
				var spinnerOpts = {
					  lines: 13 // The number of lines to draw
					, length: 0 // The length of each line
					, width: 18 // The line thickness
					, radius: 35 // The radius of the inner circle
					, scale: 0.75 // Scales overall size of the spinner
					, corners: 1 // Corner roundness (0..1)
					, color: '#000' // #rgb or #rrggbb or array of colors
					, opacity: 0.25 // Opacity of the lines
					, rotate: 0 // The rotation offset
					, direction: 1 // 1: clockwise, -1: counterclockwise
					, speed: 1 // Rounds per second
					, trail: 60 // Afterglow percentage
					, fps: 20 // Frames per second when using setTimeout() as a fallback for CSS
					, zIndex: 2e9 // The z-index (defaults to 2000000000)
					, className: 'spinner' // The CSS class to assign to the spinner
					, top: '50%' // Top position relative to parent
					, left: '50%' // Left position relative to parent
					, shadow: false // Whether to render a shadow
					, hwaccel: false // Whether to use hardware acceleration
					, position: 'absolute' // Element positioning
				};

				var spinner = new Spinner(spinnerOpts).spin(heatmapContainer);

				var digestInfo = function (info) {
					var digest = {x: 0, y: 0}, half = info.length / 2;

					for (var i = 0; i < half; i += 2) {
						digest.x += ((parseInt(info.substr(i, 2), 16) & 1) << ((half - i) / 2 - 1));
					}

					for (var i = half; i < info.length; i += 2) {
						digest.y += ((parseInt(info.substr(i, 2), 16) & 1) << ((2 *half - i) / 2 - 1));
					}
					return digest
				};

				request.get("http://" + dhtBroker + "/infos", {handleAs: "json"}).then(function(rawData) {
						var points = [];
						var max = 0;

						rawData.infos.forEach(function (info) {
							if (info.infoHash.length !== 40)
								return;

							var digest = digestInfo(info.infoHash);
							var digestStr = (digest.x/10).toFixed() + '.' + (digest.y/10).toFixed();
							var item = data.get(digestStr, null);
							if (item === null) {
								item = {infoHash: info.infoHash, x: digest.x, y: digest.y, value: info.announceNodesNum};
								data.set(digestStr, item);
							} else if (item.value < info.announceNodesNum) {
								item.infoHash = info.infoHash;
								item.x = digest.x;
								item.y = digest.y;
								item.value = info.announceNodesNum;
							}
						});

						data.forEach(function (item) {
							var fixItem = {
								x: item.x,
								y: item.y,
								value: (item.value/baseHot).toFixed()
							};
							points.push(fixItem);
							max = Math.max(max, fixItem.value);
						});

						spinner.stop();
						h.setData({
							max: max,
							data: points
						});
				});

				var tooltip = document.querySelector('.tooltip');
				var updateTooltip = function updateTooltip (x , y, value) {
					var transform = 'translate('+(x+15)+'px, '+(y+15)+'px)';
					tooltip.style.MozTransform = transform;
					tooltip.style.msTransform = transform;
					tooltip.style.OTransform = transform;
					tooltip.style.WebkitTransform = transform;
					tooltip.style.transform = transform;
					tooltip.innerHTML = value;
				};

				var wrapper = document.querySelector('.wrapper');
				var getTorrentTimer = null, currentX = 0, currentY = 0, currentMagnet = "";
				wrapper.onmousemove = function(ev) {
					var x = currentX = ev.layerX;
					var y = currentY = ev.layerY;

					var item = data.get((x/10).toFixed() + '.' + (y/10).toFixed(), null);
					if (item !== null && item.value > 0) {
						var value = 'info hash: ' + item.infoHash + '<br/>hot level: ' + item.value;
						tooltip.style.display = 'block';
						updateTooltip(x, y, value);

						getTorrentTimer && clearTimeout(getTorrentTimer);
						getTorrentTimer = setTimeout(function () {
							if (currentX === x && currentY === y) {
								request.get("http://" + dhtBroker + "/torrent?info=" + item.infoHash, {handleAs: "json"}).then(function(rawData) {
										if (currentX === x && currentY === y) {
											var newValue = 'info hash: ' + item.infoHash + '<br/>hot level: ' + item.value + '<br/>magnet link: ' + rawData.magnet;
											if (rawData.name) {
												newValue += '<br/>torrent name: ' + rawData.name;
											}

											currentMagnet = rawData.magnet;
											tooltip.style.display = 'block';
											updateTooltip(x, y, newValue);
										}
								});
							}
						}, 1000);
					} else {
						tooltip.style.display = 'none';
					}
				};
				wrapper.onmouseout = function() {
					tooltip.style.display = 'none';
				};
				wrapper.onclick = function() {
					if (tooltip.style.display === 'block') {
						var clipboard = new Clipboard('.wrapper', {
							text: function(trigger) {
								return currentMagnet;
							}
						});

						clipboard.on('success', function(e) {
							alert('copied');

							currentMagnet = "";
							clipboard.destroy();
						});

						clipboard.on('error', function(e) {
							currentMagnet = "";
							clipboard.destroy();
						});
					}
				};
    		});
    	</script>
    </body>
</html>